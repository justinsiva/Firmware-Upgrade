---
- name: Firmware Upgrade by pulling from remote server
  hosts: all
  become: yes
  vars:
    ansible_user: fpos
    ansible_ssh_pass: "s"
    ansible_become_pass: "s"
    server_user: fpos
    server_ip: "10.2.5.122"
    server_pass: "s"
    upgrade_file_pattern: "*r35_rw1*"
    scp_source_path: "/var/log/updates"
    download_path: "/home/fpos"
    final_path: "/var/log/updates"

  tasks:

    - name: Ensure sshpass is available
      package:
        name: sshpass
        state: present

    - name: Pull firmware from remote server using scp
      shell: |
        sshpass -p '{{ server_pass }}' scp {{ server_user }}@{{ server_ip }}:{{ scp_source_path }}/{{ upgrade_file_pattern }} {{ download_path }}/
      args:
        executable: /bin/bash

    - name: Wait for download to complete
      pause:
        minutes: 3

    - name: Move downloaded firmware to final path
      shell: mv {{ download_path }}/{{ upgrade_file_pattern }} {{ final_path }}/
      args:
        executable: /bin/bash

    - name: Remove old Fatpipe directory
      file:
        path: "{{ final_path }}/Fatpipe"
        state: absent

    - name: Extract the firmware archive
      shell: tar -zxvf {{ upgrade_file_pattern }}
      args:
        chdir: "{{ final_path }}"
        executable: /bin/bash

    - name: Run firmware upgrade script
      shell: ./update.sh --no-udev-check
      args:
        chdir: "{{ final_path }}/Fatpipe"
        executable: /bin/bash

    - name: Wait for script to complete
      pause:
        minutes: 5

    - name: Reboot the system
      reboot:
        reboot_timeout: 600
